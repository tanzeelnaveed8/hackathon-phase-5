version: "3.9"

# Phase 5: Event-Driven Architecture Extension
# Usage: docker-compose -f docker-compose.yml -f docker-compose.phase5.yml up
# This extends the base docker-compose.yml with Redpanda, Dapr, and microservices.

services:
  # Override backend to enable Phase 5 features
  backend:
    environment:
      - PHASE5_ENABLED=true
      - DAPR_HTTP_PORT=3500
    labels:
      - "dapr.io/enabled=true"
      - "dapr.io/app-id=backend"
      - "dapr.io/app-port=8001"

  # Redpanda (Kafka-compatible streaming platform)
  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:v23.3.5
    container_name: hackathon5-redpanda
    command:
      - redpanda
      - start
      - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:19092
      - --advertise-kafka-addr internal://redpanda:9092,external://localhost:19092
      - --pandaproxy-addr internal://0.0.0.0:8082,external://0.0.0.0:18082
      - --advertise-pandaproxy-addr internal://redpanda:8082,external://localhost:18082
      - --schema-registry-addr internal://0.0.0.0:8081,external://0.0.0.0:18081
      - --smp 1
      - --memory 512M
      - --overprovisioned
      - --default-log-level=warn
    ports:
      - "19092:19092"  # Kafka external
      - "18082:18082"  # Pandaproxy
      - "18081:18081"  # Schema registry
    volumes:
      - redpanda-data:/var/lib/redpanda/data
    healthcheck:
      test: ["CMD-SHELL", "rpk cluster health | grep -E 'Healthy:.+true'"]
      interval: 15s
      timeout: 10s
      retries: 5

  # Redpanda Console (Web UI for Kafka management)
  redpanda-console:
    image: docker.redpanda.com/redpandadata/console:v2.4.3
    container_name: hackathon5-redpanda-console
    ports:
      - "8080:8080"
    environment:
      CONFIG_FILEPATH: /tmp/config.yml
      CONSOLE_CONFIG_FILE: |
        kafka:
          brokers: ["redpanda:9092"]
        redpanda:
          adminApi:
            enabled: true
            urls: ["http://redpanda:9644"]
    depends_on:
      - redpanda

  # Dapr Sidecar for Backend
  backend-dapr:
    image: "daprio/daprd:1.12.4"
    container_name: hackathon5-backend-dapr
    command:
      [
        "./daprd",
        "--app-id", "backend",
        "--app-port", "8001",
        "--dapr-http-port", "3500",
        "--dapr-grpc-port", "50001",
        "--resources-path", "/dapr/components",
        "--log-level", "info"
      ]
    volumes:
      - ./backend/dapr/components:/dapr/components
      - ./backend/dapr/secrets.json:/dapr/secrets.json
    depends_on:
      - redpanda
      - backend
    network_mode: "service:backend"

  # Notification Service
  notification-service:
    build: ./backend/services/notification
    container_name: hackathon5-notification
    ports:
      - "8002:8002"
    environment:
      - PORT=8002
      - DAPR_HTTP_PORT=3500
    depends_on:
      - redpanda

  # Notification Service Dapr Sidecar
  notification-dapr:
    image: "daprio/daprd:1.12.4"
    container_name: hackathon5-notification-dapr
    command:
      [
        "./daprd",
        "--app-id", "notification-service",
        "--app-port", "8002",
        "--dapr-http-port", "3500",
        "--dapr-grpc-port", "50001",
        "--resources-path", "/dapr/components",
        "--log-level", "info"
      ]
    volumes:
      - ./backend/dapr/components:/dapr/components
      - ./backend/dapr/secrets.json:/dapr/secrets.json
    depends_on:
      - redpanda
      - notification-service
    network_mode: "service:notification-service"

  # Recurring Task Service
  recurring-service:
    build: ./backend/services/recurring
    container_name: hackathon5-recurring
    ports:
      - "8003:8003"
    environment:
      - PORT=8003
      - DAPR_HTTP_PORT=3500
    depends_on:
      - redpanda

  # Recurring Service Dapr Sidecar
  recurring-dapr:
    image: "daprio/daprd:1.12.4"
    container_name: hackathon5-recurring-dapr
    command:
      [
        "./daprd",
        "--app-id", "recurring-service",
        "--app-port", "8003",
        "--dapr-http-port", "3500",
        "--dapr-grpc-port", "50001",
        "--resources-path", "/dapr/components",
        "--log-level", "info"
      ]
    volumes:
      - ./backend/dapr/components:/dapr/components
      - ./backend/dapr/secrets.json:/dapr/secrets.json
    depends_on:
      - redpanda
      - recurring-service
    network_mode: "service:recurring-service"

  # WebSocket Service
  websocket-service:
    build: ./backend/services/websocket
    container_name: hackathon5-websocket
    ports:
      - "8004:8004"
    environment:
      - PORT=8004
      - DAPR_HTTP_PORT=3500
    depends_on:
      - redpanda

  # WebSocket Service Dapr Sidecar
  websocket-dapr:
    image: "daprio/daprd:1.12.4"
    container_name: hackathon5-websocket-dapr
    command:
      [
        "./daprd",
        "--app-id", "websocket-service",
        "--app-port", "8004",
        "--dapr-http-port", "3500",
        "--dapr-grpc-port", "50001",
        "--resources-path", "/dapr/components",
        "--log-level", "info"
      ]
    volumes:
      - ./backend/dapr/components:/dapr/components
      - ./backend/dapr/secrets.json:/dapr/secrets.json
    depends_on:
      - redpanda
      - websocket-service
    network_mode: "service:websocket-service"

volumes:
  redpanda-data:
